<!DOCTYPE html>
<html lang="es">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WBEK1WKFHT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WBEK1WKFHT');
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I | O</title>     <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">     <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap'); /* Space Mono for clean, monospaced look */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            position: relative; /* Needed for fixed/absolute positioning of elements over the canvas */
            background-color: black; /* Ensure HTML and Body are transparent for PNG-like background */
        }
        body {
            font-family: 'Space Mono', monospace; /* Applied new font */
            display: flex;
            color: white; /* Default text color for body, overridden where needed */
        }

        /* Canvas occupies the entire background */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block; /* Changed to block to make it visible */
            z-index: 0; /* Ensures it's in the background layer */
        }

        /* Main application container to manage "pages" */
        #app-container {
            position: relative; /* Keep relative for page content */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 1; /* Ensures UI elements are above the canvas */
            /* Add padding to the app-container to prevent content from going under fixed sidebars/header/footer */
            padding-top: 7rem; /* Approximate header height */
            padding-bottom: 5rem; /* Approximate footer height */
            padding-left: 300px; /* Left sidebar width */
            padding-right: 300px; /* Right sidebar width */
            box-sizing: border-box; /* Includes padding in dimensions */
        }

        /* Base style for each "page" (used for Maro/JuCa, not for sidebars) */
        .page {
            width: auto; /* Auto width */
            height: auto; /* Auto height */
            position: relative; /* Changed to relative inside app-container */
            flex-grow: 1; /* Allows it to grow to fill available space */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to the start */
            transition: opacity 0.3s ease-in-out;
            box-sizing: border-box;
            padding-top: 0; /* Remove padding-top, app-container handles it */
            padding-left: 1rem; /* Small internal padding */
            padding-right: 1rem; /* Small internal padding */
            overflow-y: auto; /* Allows scrolling in content pages */
        }
        .page.hidden {
            opacity: 0;
            pointer-events: none;
            display: none; /* Hides completely to not occupy space */
        }

        /* Header container (I | O and description) */
        .header-container {
            position: fixed; /* Changed to fixed */
            top: 0;
            left: 50%;
            transform: translateX(-50%); /* Horizontally centered */
            background-color: transparent; /* Removed solid fill */
            padding: 1rem 1.5rem; /* Reduced padding */
            text-align: center;
            border-bottom-left-radius: 0; /* Removed rounded corners */
            border-bottom-right-radius: 0; /* Removed rounded corners */
            box-shadow: none; /* Removed shadow */
            z-index: 10; /* Ensures it's above the canvas */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-width: 90%; /* So it's not too wide on large screens */
            box-sizing: border-box; /* Includes padding in width */
            width: auto; /* Auto width to fit content */
            min-width: 300px; /* Minimum width for the header */
        }
        .header-container.hidden {
            transform: translateX(-50%) translateY(-150%); /* Slides up to hide */
            opacity: 100;
            pointer-events: none; /* Disables interactions */
        }
        .header-container h1 {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 3rem; /* Larger title */
            font-weight: 700; /* Bold for Space Mono */
            color: white; /* White for the title */
            margin-bottom: 0.5rem;
            letter-spacing: 0.1em; /* Spacing for "I | O" */
            text-transform: uppercase; /* Keep I | O uppercase */
        }
        .header-container .description {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 1.1rem;
            color: white; /* Light text for contrast with dark background */
            margin-bottom: 0.25rem;
            text-transform: lowercase; /* Default to lowercase */
        }
        .header-container .description-sub {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 0.9rem;
            color: white; /* Slightly darker gray for sub-description */
            margin-bottom: 1.5rem;
            text-transform: lowercase; /* Default to lowercase */
        }
        /* Specific font size for profile page headers */
        .page .header-container .description {
            font-size: 1.7rem; /* Increased font size for profile name */
        }
        .page .header-container .description-sub {
            font-size: 1.5rem; /* Increased font size for profile subtitle */
        }
        .social-buttons {
            display: flex;
            justify-content: center;
            gap: 1.5rem; /* Increased space between icons */
            flex-wrap: wrap;
        }
        .social-btn {
            font-family: 'Space Mono', monospace; /* Applied new font */
            display: flex;
            align-items: center;
            justify-content: center; /* Center icon */
            width: auto; /* Auto width, not fixed */
            height: auto; /* Auto height, not fixed */
            padding: 0; /* Remove padding */
            font-size: 1.8rem; /* Larger icon size */
            background-color: transparent; /* Transparent background */
            color: white; /* White icon */
            border-radius: 0; /* No rounded corners */
            font-weight: bold; /* Doesn't apply much to icons, but kept */
            cursor: pointer;
            transition: transform 0.1s ease; /* Only transform transition */
            box-shadow: none; /* No shadow */
            border: none; /* No outline */
            text-decoration: none; /* Remove link underline */
            text-transform: lowercase; /* Default to lowercase */
        }
        .social-btn:hover {
            transform: translateY(-2px); /* Lift effect on hover */
            background-color: transparent; /* Ensure background remains transparent */
        }
        .social-btn:active {
            transform: translateY(0);
            box-shadow: none; /* Ensure no shadow on click */
        }

        /* Left sidebar container */
        .left-sidebar-container {
            position: fixed; /* Changed to fixed */
            top: 7rem; /* Starts below the header */
            left: 0;
            height: calc(100% - 7rem - 5rem); /* Adjust height to fill remaining space, accounting for footer */
            width: 300px; /* Fixed width for the side UI */
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent black */
            z-index: 9; /* Ensures it's above the canvas but below the header */
            display: flex;
            flex-direction: column;
            padding: 0.75rem; /* Reduced padding */
            box-sizing: border-box; /* Includes padding in width */
            border-right: 1px solid white; /* Subtle right separator */
            border-top-right-radius: 0.75rem; /* Rounded corners at the top right */
            border-bottom-right-radius: 0.75rem; /* Rounded corners at the bottom right */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .left-sidebar-container.hidden {
            transform: translateX(-100%); /* Slides left to hide */
            opacity: 0;
            pointer-events: none; /* Disables interactions */
        }

        /* Right sidebar container */
        .right-sidebar-container {
            position: fixed; /* Changed to fixed */
            top: 7rem; /* Starts below the header */
            right: 0;
            height: calc(100% - 7rem - 5rem); /* Adjust height to fill remaining space, accounting for footer */
            width: 300px;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent black */
            z-index: 9;
            display: flex;
            flex-direction: column;
            padding: 0.75rem; /* Reduced padding */
            box-sizing: border-box;
            border-left: 1px solid white; /* Subtle left separator */
            border-top-left-radius: 0.75rem; /* Rounded corners at the top left */
            border-bottom-left-radius: 0.75rem; /* Rounded corners at the bottom left */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .right-sidebar-container.hidden { /* This class will be added by JS */
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }

        /* Scrollable controls container */
        .main-controls-scrollable {
            flex-grow: 1; /* Occupies remaining space */
            overflow-y: auto; /* Allows scrolling */
            padding-right: 0.5rem; /* Space for scrollbar */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Space between control groups */
        }
        /* Scrollbar style */
        .main-controls-scrollable::-webkit-scrollbar {
            width: 8px;
        }
        .main-controls-scrollable::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        .main-controls-scrollable::-webkit-scrollbar-thumb {
            background: white; /* White scrollbar thumb */
            border-radius: 10px;
        }
        .main-controls-scrollable::-webkit-scrollbar-thumb:hover {
            background: #cccccc; /* Lighter gray on hover */
        }

        .control-group-box {
            background-color: white; /* White background for grouped boxes */
            padding: 0.6rem; /* Reduced padding */
            border-radius: 0.6rem;
            box-shadow: none; /* No shadow */
            border: 1px solid black; /* Black border for definition */
            display: flex;
            flex-direction: column;
            gap: 0.6rem; /* Reduced space between elements within the group */
        }
        .control-group-box h3 {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 0.85rem; /* Smaller group title */
            font-weight: bold;
            margin-bottom: 0.2rem;
            color: black; /* Dark text for titles */
            text-transform: lowercase; /* Default to lowercase */
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem; /* Smaller space in slider groups */
        }
        .control-group label {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 0.75rem; /* Smaller label size */
            color: black; /* Dark text for labels */
            text-transform: lowercase; /* Default to lowercase */
        }
        .control-group input[type="range"] {
            width: 100%; /* Occupies full available width */
            -webkit-appearance: none;
            height: 5px; /* Thinner slider */
            background: black; /* Black track */
            border-radius: 3px;
            outline: none;
            opacity: 1; /* Fully opaque */
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px; /* Smaller thumb */
            height: 14px;
            border-radius: 50%;
            background: white; /* White thumb */
            cursor: pointer;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.5); /* Black shadow */
        }
        .control-group input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white; /* White thumb */
            cursor: pointer;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.5); /* Black shadow */
        }
        /* Style for selectors that are also buttons */
        .control-group select.btn {
            font-family: 'Space Mono', monospace; /* Applied new font */
            padding: 0.4rem 0.6rem; /* Adjusted padding */
            font-size: 0.8rem; /* Adjusted font size */
            text-align: left; /* Align text to the left */
            -webkit-appearance: none; /* Remove native style in Webkit */
            -moz-appearance: none; /* Remove native style in Firefox */
            appearance: none; /* Remove native style */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.2-3.2-8.4-3.2-11.6%2C0L5.4%2C197.3c-3.2%2C3.2-3.2%2C8.4%2C0%2C11.6l11.6%2C11.6c3.2%2C3.2%2C8.4%2C3.2%2C11.6%2C0l120.4-120.4l120.4%2C120.4c3.2%2C3.2%2C8.4%2C3.2%2C11.6%2C0l11.6-11.6C290.2%2C205.7%2C290.2%2C200.5%2C287%2C197.3z%22%2F%3E%3C%2Fsvg%3E'); /* Black arrow */
            background-repeat: no-repeat;
            background-position: right 0.6rem center; /* Adjusted arrow position */
            background-size: 0.5em auto; /* Smaller arrow size */
            background-color: white; /* White background */
            color: black; /* Black text */
            border: 1px solid black; /* Black border */
            text-transform: lowercase; /* Default to lowercase */
        }

        /* General style for all buttons */
        .btn {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background: white; /* White background */
            color: black; /* Black text */
            padding: 0.6rem 1rem; /* Reduced padding */
            border-radius: 0.6rem; /* Smaller borders */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Smooth transition for all properties */
            box-shadow: none; /* Removed shadow */
            border: 1px solid black; /* Added border */
            width: 100%; /* Ensures buttons within sections occupy full width */
            box-sizing: border-box;
            text-transform: lowercase; /* Default to lowercase */
            letter-spacing: 0.05em; /* Letter spacing */
        }
        .btn:hover {
            background: #e0e0e0; /* Lighter gray on hover */
            transform: translateY(-2px); /* More pronounced lift effect */
            box-shadow: none; /* Removed shadow on hover */
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: none; /* Removed shadow on click */
            background: #cccccc; /* Darker gray on click */
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .message-box {
            font-family: 'Space Mono', monospace; /* Applied new font */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white; /* White message box */
            color: black; /* Black text */
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .message-box button {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: black; /* Black button */
            color: white; /* White text */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            text-transform: lowercase; /* Default to lowercase */
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: black; /* Black checkbox */
        }
        .color-palette {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .color-input-group input[type="color"] {
            width: 40px;
            height: 25px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .color-input-group input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-input-group input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.25rem;
        }
        /* Credits and profile buttons */
        .footer-container {
            position: fixed; /* Changed to fixed */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto; /* Auto width to fit content */
            min-width: 300px; /* Minimum width for the footer */
            text-align: center;
            padding: 1rem 1.5rem; /* Match header padding */
            background-color: transparent; /* Transparent background */
            border-top-left-radius: 0; /* No rounded corners */
            border-top-right-radius: 0; /* No rounded corners */
            box-shadow: none; /* No shadow */
            z-index: 10;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            box-sizing: border-box;
        }
        .footer-container.hidden {
            transform: translateX(-50%) translateY(150%); /* Slides down to hide */
            opacity: 0;
            pointer-events: none;
        }
        .footer-text {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 0.9rem;
            color: white; /* White text */
            margin-bottom: 0.75rem;
            text-transform: lowercase; /* Default to lowercase */
        }
        .profile-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .profile-btn {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: transparent; /* Transparent background */
            color: white; /* White text */
            padding: 0; /* No padding */
            border-radius: 0; /* No borders */
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s ease;
            box-shadow: none; /* No shadow */
            border: none; /* No border */
            font-size: 1.2rem; /* Font size to look like social media icon */
            text-transform: lowercase; /* Default to lowercase */
        }
        .profile-btn:hover {
            transform: translateY(-2px);
            background-color: transparent;
        }
        .profile-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #audioDebugInfo {
            font-family: 'Space Mono', monospace; /* Applied new font */
            position: fixed; /* Changed to fixed */
            top: 8rem; /* Below the header */
            right: 310px; /* To the left of the right sidebar */
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            z-index: 100;
            display: none; /* Hidden by default, shown when audio is active */
            text-transform: lowercase; /* Default to lowercase */
        }

        /* Styles for profile pages */
        .profile-page-content {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: rgba(255, 255, 255, 0.1); /* Transparent white background */
            padding: 2rem;
            border-radius: 0; /* Removed border-radius */
            box-shadow: none; /* Removed box-shadow */
            max-width: 96%; /* Occupy almost full width */
            width: 96%; /* Occupy almost full width */
            margin-top: 7rem; /* Slightly lower margin-top */
            text-align: left;
            overflow-y: auto;
            flex-grow: 1;
            box-sizing: border-box;
            display: flex; /* Use flexbox for content */
            flex-direction: column; /* Content in column */
            gap: 1rem; /* Space between elements */
            color: white; /* White text */
        }
        .profile-page-content h2 {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 2rem;
            font-weight: bold;
            color: white; /* White text */
            margin-bottom: 1rem;
            text-align: center;
            text-transform: lowercase; /* Default to lowercase */
        }
        .profile-page-content h3 {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 1.5rem;
            font-weight: bold;
            color: white; /* White text */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            text-transform: lowercase; /* Default to lowercase */
        }
        .profile-page-content p, .profile-page-content ul {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 1rem;
            line-height: 2; /* Increased line-height */
            color: white; /* White text */
            margin-bottom: 1rem;
            text-transform: lowercase; /* Default to lowercase */
        }
        .profile-page-content ul {
            list-style: disc;
            margin-left: 1.5rem;
        }
        .profile-page-content a {
            color: #ccc; /* Lighter gray for links */
            text-decoration: underline;
            text-transform: lowercase;
        }
        .profile-page-content .project-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .back-btn-container {
            width: 100%;
            text-align: center;
            margin-top: 2rem;
            flex-shrink: 0;
        }
        .back-btn {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: black; /* Black button */
            color: white; /* White text */
            padding: 0.8rem 1.8rem;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            border: none;
            text-transform: lowercase; /* Default to lowercase */
        }
        .back-btn:hover {
            background-color: #333; /* Darker black on hover */
            transform: translateY(-2px);
        }
        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Specific styles for MIDI section (inside left-sidebar-container) */
        .midi-control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .midi-control-group label {
            font-family: 'Space Mono', monospace; /* Applied new font */
            font-size: 0.9rem;
            color: white; /* White text on dark sidebar */
            text-transform: lowercase; /* Default to lowercase */
        }
        .midi-control-group select, .midi-control-group input[type="number"] {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: white; /* White background */
            border: 1px solid black; /* Black border */
            color: black; /* Black text */
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            text-transform: lowercase; /* Default to lowercase */
        }
        .midi-control-group button {
            width: auto;
            align-self: flex-start;
        }
        .midi-monitor {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: #f0f0f0; /* Light gray for monitor */
            border: 1px solid black; /* Black border */
            padding: 0.6rem; /* Reduced padding */
            border-radius: 0.6rem;
            font-size: 0.75rem; /* Reduced font size */
            color: black; /* Black text */
            height: 80px; /* Reduced height */
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            text-transform: lowercase; /* Default to lowercase */
        }
        .midi-mappings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .midi-mappings-table th, .midi-mappings-table td {
            font-family: 'Space Mono', monospace; /* Applied new font */
            border: 1px solid black; /* Black border */
            padding: 0.4rem; /* Reduced padding */
            text-align: left;
            font-size: 0.8rem; /* Reduced font size */
            text-transform: lowercase; /* Default to lowercase */
        }
        .midi-mappings-table th {
            background-color: black; /* Black header */
            color: white; /* White text */
        }
        .midi-mappings-table td button {
            font-family: 'Space Mono', monospace; /* Applied new font */
            padding: 0.2rem 0.4rem; /* Reduced button padding */
            font-size: 0.7rem; /* Reduced button font size */
            border-radius: 0.5rem;
            background-color: black; /* Black for delete */
            color: white; /* White text */
            text-transform: lowercase; /* Default to lowercase */
        }
        .midi-learn-status {
            font-family: 'Space Mono', monospace; /* Applied new font */
            background-color: black; /* Black background */
            color: white; /* White text */
            padding: 0.75rem;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: bold;
            margin-bottom: 1rem;
            display: none; /* Hidden by default */
            text-transform: lowercase; /* Default to lowercase */
        }
        .midi-learn-status.active {
            display: block;
        }

        /* Class to highlight controls when MIDI learn mode is active */
        .learn-mode-active .mappable-control {
            border: 2px dashed white; /* Dashed white border */
            cursor: crosshair; /* Crosshair cursor to indicate mapping */
        }
        .mappable-control:hover {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.7); /* Black shadow on hover */
        }


/* --- Global UI Containers (Responsivo) --- */
.header-container, .footer-container {
    position: fixed; left: 50%; transform: translateX(-50%);
    width: auto; min-width: 300px; text-align: center; padding: 1rem 1.5rem;
    background-color: transparent; box-shadow: none; z-index: 10;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    box-sizing: border-box;
}
.header-container { top: 0; }
.footer-container { bottom: 0; }
.header-container.hidden { transform: translateX(-50%) translateY(-150%); opacity: 0; pointer-events: none; }
.footer-container.hidden { transform: translateX(-50%) translateY(150%); opacity: 0; pointer-events: none; }
.left-sidebar-container, .right-sidebar-container {
    position: fixed; top: 7rem; height: calc(100% - 7rem - 5rem); width: 300px;
    background-color: rgba(0, 0, 0, 0.8); z-index: 9; display: flex; flex-direction: column; padding: 0.75rem;
    box-sizing: border-box; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
}
.left-sidebar-container { left: 0; border-right: 1px solid white; border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
.right-sidebar-container { right: 0; border-left: 1px solid white; border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
.left-sidebar-container.hidden { transform: translateX(-100%); opacity: 0; pointer-events: none; }
.right-sidebar-container.hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
.page.hidden { opacity: 0; pointer-events: none; display: none; }

/* New Buttons for Mobile Menus */
#sidebarToggleLeft, #sidebarToggleRight {
    display: none; /* Initially hidden on desktop */
    position: fixed;
    z-index: 20;
    top: 1rem;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid white;
    border-radius: 8px;
}
#sidebarToggleLeft { left: 1rem; }
#sidebarToggleRight { right: 1rem; }

/* Mobile Specific Styles (media query para pantallas chicas) */
@media (max-width: 768px) {
    /* Full-screen UI containers (no padding) */
    #app-container {
        padding-left: 0;
        padding-right: 0;
    }

    /* Show UI elements from the top for better accessibility */
    .header-container, .footer-container {
        position: fixed;
        left: 0;
        transform: none;
        width: 100%;
        min-width: unset;
        padding: 1rem;
    }

    /* Sidebars go full width and occupy half screen height from top/bottom */
    .left-sidebar-container, .right-sidebar-container {
        top: unset;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 50vh; /* Half of viewport height */
        padding: 1rem;
        border-left: none;
        border-right: none;
        border-top: 1px solid white;
        border-radius: 0;
        transform: translateY(100%); /* Start hidden from the bottom */
        transition: transform 0.3s ease-in-out;
    }
    .left-sidebar-container.active, .right-sidebar-container.active {
        transform: translateY(0); /* Slide up to be visible */
    }

    /* Show the toggle buttons on mobile */
    #sidebarToggleLeft, #sidebarToggleRight {
        display: block;
    }
    
    /* Hide the sidebars completely when hidden on mobile for correct toggle behavior */
    .right-sidebar-container.hidden, .left-sidebar-container.hidden {
        opacity: 1; /* Keep opacity at 1 for slide effect */
        pointer-events: auto; /* Allow clicks to open the menu */
        transform: translateY(100%);
    }

    /* Adjustments for specific elements */
    .profile-page-content {
        margin-top: 5rem; /* Space from the top header */
        padding: 1rem;
    }
    #audioDebugInfo {
        right: 1rem;
        top: 5rem;
        padding: 0.25rem;
        font-size: 0.6rem;
    }
}
</style>
</head>
<body>
    <canvas id="visualCanvas"></canvas>

    <div id="app-container">
        <button id="sidebarToggleLeft" class="btn">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button id="sidebarToggleRight" class="btn">
            <i class="fas fa-filter"></i>
        </button>

                <div id="mainVisualizerPage" class="page active">
            <div class="header-container" id="headerContainerMain">
                <h1>I | O</h1>
                <p class="description">"signal in, chaos out"</p>
                <p class="description-sub">música experimental + visuales</p>
                <div class="social-buttons">
                    <a href="https://www.tiktok.com/@juca.noiz" target="_blank" class="social-btn">
                        <i class="fab fa-tiktok"></i>
                    </a>
                    <a href="https://www.instagram.com/jucanoiz/" target="_blank" class="social-btn">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://www.facebook.com/juca.noiz.2025" target="_blank" class="social-btn">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    </a>
                </div>
            </div>

            <div class="left-sidebar-container hidden" id="leftSidebarContainer">
                <div class="main-controls-scrollable">
                    <div class="control-group-box">
                        <h3>modo visual</h3>
                        <div class="control-group">
                            <label for="visualMode">seleccionar modo:</label>
                            <select id="visualMode" class="btn mappable-control" data-midi-target="visualMode">
                                <option value="spheres">esferas pulsantes</option>
                                <option value="particles">partículas reactivas</option>
                                <option value="waves">ondas de color</option>
                                <option value="cubes">cubos giratorios</option>
                                <option value="audioBars">barras de audio</option>
                                <option value="torus">toroides múltiples</option>
                                <option value="torusKnot">nudo toroide</option>
                                <option value="dodecahedron">dodecaedros múltiples</option>
                                <option value="icosahedron">icosaedros múltiples</option>
                                <option value="octahedron">octaedros múltiples</option>
                                <option value="cone">conos múltiples</option>
                                <option value="cylinder">cilindros múltiples</option>
                                <option value="ring">anillos múltiples</option>
                                <option value="tetrahedron">tetraedros múltiples</option>
                                <option value="multiTorus">multi-toroides</option>
                                <option value="gyroscope1">giroscopio de anillos</option>
                                <option value="gyroscope2">giroscopio de esferas anidadas</option>
                                <option value="gyroscope3">giroscopio de toroides intersectados</option>
                                <option value="fractalNoise">ruido fractal</option>
                                <option value="hydraFuego">hydra fuego cósmico</option>
                                <option value="hydraGlitch">hydra glitch dimension</option>                                 <option value="hydraTunel">hydra túnel espacial</option>                             </select>
                        </div>
                    </div>

                    <div class="control-group-box">
                        <h3>controles de visualización</h3>
                        <div class="control-group">
                            <label for="colorSpeed">vel. color:</label>
                            <input type="range" id="colorSpeed" min="0.01" max="0.5" step="0.01" value="0.1" class="mappable-control" data-midi-target="colorSpeed">
                        </div>
                        <div class="control-group">
                            <label for="amplitudeSensitivity">sens. audio general:</label>
                            <input type="range" id="amplitudeSensitivity" min="0.1" max="5.0" step="0.1" value="1.0" class="mappable-control" data-midi-target="amplitudeSensitivity">
                        </div>
                        <div class="control-group">
                            <label for="audioReactionThreshold">umbral audio (db):</label>
                            <input type="range" id="audioReactionThreshold" min="0" max="255" step="1" value="45" class="mappable-control" data-midi-target="audioReactionThreshold">
                        </div>
                        <div class="control-group">
                            <label for="bassSensitivity">sens. graves:</label>
                            <input type="range" id="bassSensitivity" min="0.1" max="5.0" step="0.1" value="1.0" class="mappable-control" data-midi-target="bassSensitivity">
                        </div>
                        <div class="control-group">
                            <label for="midSensitivity">sens. medios:</label>
                            <input type="range" id="midSensitivity" min="0.1" max="5.0" step="0.1" value="1.0" class="mappable-control" data-midi-target="midSensitivity">
                        </div>
                        <div class="control-group">
                            <label for="trebleSensitivity">sens. agudos:</label>
                            <input type="range" id="trebleSensitivity" min="0.1" max="5.0" step="0.1" value="1.0" class="mappable-control" data-midi-target="trebleSensitivity">
                        </div>
                        <div class="control-group">
                            <label for="layerOpacity">opacidad capa:</label>
                            <input type="range" id="layerOpacity" min="0.1" max="1.0" step="0.05" value="1.0" class="mappable-control" data-midi-target="layerOpacity">
                        </div>
                        <div class="control-group">
                            <label for="shapeScale">escala global:</label>
                            <input type="range" id="shapeScale" min="0.1" max="2.0" step="0.05" value="1.0" class="mappable-control" data-midi-target="shapeScale">
                        </div>
                        <div class="control-group">
                            <label for="deformationLevel">nivel deformación:</label>
                            <input type="range" id="deformationLevel" min="0.0" max="1.0" step="0.01" value="0.5" class="mappable-control" data-midi-target="deformationLevel">
                        </div>
                        <div class="control-group">
                            <label for="materialMode">modo material:</label>
                            <input type="range" id="materialMode" min="0" max="2" step="1" value="0" class="mappable-control" data-midi-target="materialMode">
                        </div>
                    </div>

                    <div class="control-group-box">
                        <h3>opciones de color y más</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="grayscaleToggle" class="mappable-control" data-midi-target="grayscaleToggle">
                            <label for="grayscaleToggle">escala de grises figuras</label>
                        </div>

                        <div class="color-palette">
                            <label>colores custom:</label>
                            <div class="color-input-group">
                                <input type="color" id="color1" value="#FF0000" class="mappable-control" data-midi-target="color1">
                                <input type="color" id="color2" value="#00FF00" class="mappable-control" data-midi-target="color2">
                                <input type="color" id="color3" value="#0000FF" class="mappable-control" data-midi-target="color3">
                            </div>
                            <div class="color-input-group">
                                <input type="color" id="color4" value="#FFFF00" class="mappable-control" data-midi-target="color4">
                                <input type="color" id="color5" value="#FF00FF" class="mappable-control" data-midi-target="color5">
                                <input type="color" id="color6" value="#00FFFF" class="mappable-control" data-midi-target="color6">
                            </div>
                        </div>
                    </div>

                    <div class="control-group-box">
                        <h3>dispositivos de entrada</h3>
                        <div class="control-group">
                            <label for="audioInputSelect">entrada de audio:</label>
                            <select id="audioInputSelect" class="btn mappable-control" data-midi-target="audioInputSelect"></select>
                        </div>
                        <div class="control-group">
                            <label for="cameraSelect">seleccionar cámara:</label>
                            <select id="cameraSelect" class="btn mappable-control" data-midi-target="cameraSelect"></select>
                        </div>
                    </div>

                    <div class="control-group-box actions-box">                         <h3>acciones</h3>
                        <button id="toggleAudio" class="btn mappable-control" data-midi-target="toggleAudio">activar audio</button>
                        <div class="file-input-wrapper">
                            <button class="btn">cargar imagen</button>
                            <input type="file" id="imageUpload" accept="image/*" multiple>
                        </div>
                        <button id="clearImageBtn" class="btn mappable-control" data-midi-target="clearImageBtn">borrar imagen de fondo</button>
                        <button id="fullscreenBtn" class="btn mappable-control" data-midi-target="fullscreenBtn">pantalla completa</button>
                    </div>
                </div>
            </div>

                        <div class="right-sidebar-container hidden" id="rightSidebarContainer">
                <div class="main-controls-scrollable">
                    <div class="control-group-box">
                        <h3>filtros de imagen de fondo</h3>
                        <div class="color-input-group">
                            <label for="chromaKeyColor">color chroma key:</label>
                            <input type="color" id="chromaKeyColor" value="#00FF00" class="mappable-control" data-midi-target="chromaKeyColor">
                        </div>
                        <div class="control-group">
                            <label for="chromaKeyThreshold">umbral chroma key:</label>
                            <input type="range" id="chromaKeyThreshold" min="0.0" max="0.5" step="0.01" value="0.001" class="mappable-control" data-midi-target="chromaKeyThreshold">
                        </div>
                        <div class="control-group">
                            <label for="backgroundScaleSlider">escala de fondo:</label>
                            <input type="range" id="backgroundScaleSlider" min="0.5" max="5.0" step="0.1" value="1.5" class="mappable-control" data-midi-target="backgroundScaleFactor">
                        </div>
                                                <div class="control-group">
                            <label for="hueRotateSlider">rotación de tono:</label>
                            <input type="range" id="hueRotateSlider" min="0" max="360" step="1" value="0" class="mappable-control" data-midi-target="hueRotate">
                        </div>
                        <div class="control-group">
                            <label for="saturationSlider">saturación:</label>
                            <input type="range" id="saturationSlider" min="0" max="200" step="1" value="100" class="mappable-control" data-midi-target="saturation">
                        </div>
                        <div class="control-group">
                            <label for="vignetteSlider">viñeta:</label>
                            <input type="range" id="vignetteSlider" min="0" max="100" step="1" value="0" class="mappable-control" data-midi-target="vignette">
                        </div>
                        <div class="control-group">
                            <label for="posterizeSlider">posterizar:</label>
                            <input type="range" id="posterizeSlider" min="2" max="255" step="1" value="255" class="mappable-control" data-midi-target="posterize">
                        </div>
                        <div class="control-group">
                            <label for="sharpenSlider">nitidez:</label>
                            <input type="range" id="sharpenSlider" min="0" max="10" step="0.1" value="0" class="mappable-control" data-midi-target="sharpen">
                        </div>
                        <div class="control-group">
                            <label for="scanlineSlider">líneas de escaneo:</label>
                            <input type="range" id="scanlineSlider" min="0" max="100" step="1" value="0" class="mappable-control" data-midi-target="scanline">
                        </div>
                    </div>

                    <div class="control-group-box">
                        <h3>controles de cámara</h3>
                        <button id="startCameraBtn" class="btn mappable-control" data-midi-target="startCameraBtn">activar cámara</button>
                        <button id="stopCameraBtn" class="btn mappable-control" data-midi-target="stopCameraBtn">detener cámara</button>
                        <div class="control-group">
                            <label for="cameraFilterModeSelect">filtro base:</label>
                            <select id="cameraFilterModeSelect" class="btn mappable-control" data-midi-target="cameraFilterModeSelect">
                                <option value="0">ninguno</option>
                                <option value="1">escala de grises</option>
                                <option value="2">invertir colores</option>
                                <option value="3">sepia</option>
                                <option value="4">pixelado</option>
                                <option value="5">desenfoque</option>
                                <option value="6">solo bordes</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="cameraNoiseSlider">ruido bordes:</label>
                            <input type="range" id="cameraNoiseSlider" min="0" max="100" value="0" class="mappable-control" data-midi-target="cameraNoiseAmount">
                        </div>
                        <div class="control-group">
                            <label for="cameraEdgeSensitivitySlider">sensibilidad bordes:</label>
                            <input type="range" id="cameraEdgeSensitivitySlider" min="0" max="100" value="50" class="mappable-control" data-midi-target="cameraEdgeSensitivity">
                        </div>
                        <div class="control-group">
                            <label for="cameraBrightnessSlider">brillo:</label>
                            <input type="range" id="cameraBrightnessSlider" min="-100" max="100" value="0" class="mappable-control" data-midi-target="cameraBrightness">
                        </div>
                        <div class="control-group">
                            <label for="cameraContrastSlider">contraste:</label>
                            <input type="range" id="cameraContrastSlider" min="0" max="100" value="50" class="mappable-control" data-midi-target="cameraContrast">
                        </div>
                        <div class="control-group">
                            <label for="cameraPixelateSizeSlider">tamaño pixel:</label>
                            <input type="range" id="cameraPixelateSizeSlider" min="1" max="50" value="1" class="mappable-control" data-midi-target="cameraPixelateSize">
                        </div>
                        <div class="control-group">
                            <label for="cameraBlurAmountSlider">intensidad desenfoque:</label>
                            <input type="range" id="cameraBlurAmountSlider" min="0" max="10" value="0" class="mappable-control" data-midi-target="cameraBlurAmount">
                        </div>
                        <div class="control-group">
                            <label for="cameraMaterialSelect">tinte bordes:</label>
                            <select id="cameraMaterialSelect" class="btn mappable-control" data-midi-target="cameraMaterialColor">
                                <option value="none">normal</option>
                                <option value="mercury">mercurio</option>
                                <option value="gold">oro</option>
                                <option value="lava">lava</option>
                                <option value="water">agua</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group-box">
                        <h3>control midi</h3>
                        <div class="midi-control-group">
                            <label for="midiInputSelect">entrada midi:</label>
                            <select id="midiInputSelect"></select>
                        </div>
                        <div class="midi-control-group">
                            <label for="midiOutputSelect">salida midi (futuro):</label>
                            <select id="midiOutputSelect"></select>
                        </div>
                        <div class="control-group">
                            <label for="midiChannelInput">canal midi (1-16):</label>
                            <input type="number" id="midiChannelInput" min="1" max="16" value="1">
                        </div>

                        <h3>modo de aprendizaje midi</h3>
                        <div class="midi-control-group">
                            <button id="startMidiLearnBtn" class="btn">iniciar aprendizaje midi</button>
                            <button id="stopMidiLearnBtn" class="btn" style="display: none;">detener aprendizaje midi</button>
                        </div>
                        <p id="midiLearnStatus" class="midi-learn-status">haz clic en un control visual para mapearlo.</p>

                        <h3>mapeos actuales</h3>
                        <button id="clearMidiMappingsBtn" class="btn">borrar todos los mapeos</button>
                        <table class="midi-mappings-table">
                            <thead>
                                <tr>
                                    <th>tipo midi</th>
                                    <th>canal</th>
                                    <th>número</th>
                                    <th>control visual</th>
                                    <th>acción</th>
                                </tr>
                            </thead>
                            <tbody id="midiMappingsTableBody">
                                                            </tbody>
                        </table>

                        <h3>monitor midi</h3>
                        <div id="midiMonitor" class="midi-monitor"></div>
                    </div>
            </div>


            <div class="footer-container" id="footerContainer">
                <p class="footer-text">creado por juca noiz | aural flux®</p>
                <div class="profile-buttons">
                    <button id="jucaProfileBtn" class="profile-btn">JuCa Noiz</button>
                    <button id="maroProfileBtn" class="profile-btn">Maro Valdivia</button>
                </div>
            </div>
        </div>

                <div id="jucaPage" class="page hidden">
            <div class="header-container">
                <h1>I | O</h1>
                <p class="description">JuCa Noiz</p>
                <p class="description-sub">ingeniero y diseñador de experiencias</p>
            </div>
            <div class="profile-page-content">
                <h2>perfil de JuCa Noiz</h2>
                <h3>biografía</h3>
                <p>JuCa Noiz es un ingeniero y diseñador de experiencias, especializado en la creación de paisajes sonoros y la integración de audio con visuales interactivos. su enfoque se centra en cómo el sonido puede moldear y ser moldeado por entornos visuales, explorando la sinestesia digital.</p>
                <p>con una profunda comprensión de la acústica y el procesamiento de señales, JuCa aporta una perspectiva técnica y artística a proyectos que buscan fusionar la música experimental con la interactividad visual, creando atmósferas envolventes y multisensoriales.</p>

                <h3>proyectos destacados</h3>
                <ul>
                    <li>I | O Web: una plataforma interactiva para la generación de visuales en tiempo real, donde el sonido y los controles MIDI dan vida a experiencias inmersivas.</li>
                    <li>Participación como sintetista en Tech-Noch: explorando la fusión de la cultura digital con las raíces sonoras más profundas, ¡creando un desmadre sonoro y visual que te vuela la cabeza!</li>
                    <li>"Resonance Chambers": una serie de experimentos sonoros que utilizan la resonancia de espacios físicos para generar visuales reactivos.</li>
                    <li>"Glitch Garden": un entorno interactivo donde los sonidos de la naturaleza son procesados y visualizados como fallas digitales.</li>
                    <li>"Sonic Sculptures": colaboraciones con escultores para crear piezas que emiten y reaccionan a estímulos sonoros.</li>
                </ul>

                <h3>filosofía artística</h3>
                <p>JuCa cree que el sonido es una fuerza fundamental en la experiencia humana, capaz de evocar emociones y transformar la percepción. su trabajo busca amplificar esta fuerza, utilizando la tecnología para revelar la belleza oculta en el ruido y la armonía, creando diálogos entre lo audible y lo visible.</p>
            </div>
            <div class="back-btn-container">
                <button class="back-btn" data-target-page="mainVisualizerPage">volver</button>
            </div>
        </div>

                <div id="maroPage" class="page hidden">
            <div class="header-container">
                <h1>I | O</h1>
                <p class="description">Maro Valdivia</p>
                <p class="description-sub">artista audiovisual</p>
            </div>
            <div class="profile-page-content">
                <h2>perfil de Maro Valdivia</h2>
                <h3>biografía</h3>
                <p>originario de Ciudad de México, Omar Valdivia es un artista multidisciplinario que fusiona elementos tradicionales y contemporáneos para crear experiencias sonoras y visuales únicas. su obra trasciende los límites convencionales, combinando diversos géneros y estilos para ofrecer composiciones innovadoras y cautivadoras. su habilidad para integrar diferentes disciplinas lo convierte en un creador de experiencias únicas, reflejando su profunda comprensión del arte como un medio en constante evolución.</p>

                <h3>Tech-Noch</h3>
                <p>Tech-Noch es un proyecto que explora la cultura y la tecnología a través de herramientas como el videomapping, la música y la creación digital, para generar experiencias visuales y auditivas inmersivas. Tech-Noch sirve como un puente entre el pasado y el futuro, ofreciendo una experiencia que vincula a las personas con sus raíces culturales, al tiempo que exploran las infinitas posibilidades de la tecnología.</p>

                <h3>apariciones destacadas</h3>
                <ul>
                    <li>Cryptofest, Tulúm, Q. Roo: videomapping con video proyecciones de colaboradores de Arteknov, sobre hongo de palma y lasers proyectados en lago. colaboración con Tulaaart, Arteknov.</li>
                    <li>Festival Prisma, Mérida, Yucatán: participación con video proyecciones como apoyo para la carrera de diseño y nuevos medios en el Gran Museo del Mundo Maya. colaboración con Universidad Anáhuac Mayab, Tulaaart.</li>
                    <li>Festival Naltik, Zacatlán, Puebla: colección de templos y pirámides proyectados con laser en las nubes sobrepuesto a la ciudad de Zacatlán de las Manzanas. videomapping al templo del "Señor del Cable" de la serie "Bandalismo Espiritual". colaboración con Transductor, Black3Labs.</li>
                    <li>Panteon MX, CDMX, MX: videomapping para inauguración de exposición del STP Crew. colaboración con Transductor, N30, STP Crew, Maldita Carmen, Meme.ZP.3KTRA, Fabs, Alibe, Nomoneynohoney.</li>
                    <li>Nektar, CDMX, MX y Toluca, Edo. Mex.: pre-lanzamiento de bebida Purple Haze de la marca Nektar, fiesta para influencers y artistas. colaboración con Sinestechnia, NEUG, WTS, Noise Diva.</li>
                    <li>Festival Data Uotan, CDMX, MX: participación con videomapping interactivo colaboración de obra de Ricardo Santos "Cocodrilos" para Festival Data Uotan patrocinado por la Embajada de Paises Bajos en México. colaboración con Ricardo Santos, NEUG, Uncloud, Alejandra Metztli.</li>
                    <li>"Abundance", CDMX, MX: participación para RE:INTEGRA. modelo: Michelle Favreau, artista de pintura: Bella Schauer, fotógrafo: Summer Hokulani, proyección: Tech-Noch.</li>
                </ul>
                
                <h3>contacto</h3>
                <p>web: <a href="https://www.omargarciavaldivia.com" target="_blank" style="color: white; text-decoration: underline;">www.omargarciavaldivia.com</a></p>
                <p>instagram: <a href="https://www.instagram.com/omar_valdivia" target="_blank" style="color: white; text-decoration: underline;">@omar_valdivia</a> / <a href="https://www.instagram.com/tech_noch" target="_blank" style="color: white; text-decoration: underline;">@tech_noch</a></p>
                <p>email: <a href="mailto:OMAR.G.VALDIVIA@GMAIL.COM" style="color: white; text-decoration: underline;">omar.g.valdivia@gmail.com</a></p>
            </div>
            <div class="back-btn-container">
                <button class="back-btn" data-target-page="mainVisualizerPage">volver</button>
            </div>
        </div>
    </div>

    <div id="audioDebugInfo">
        amplitud audio: <span id="currentAmplitude">0</span><br>
        nivel reacción: <span id="normalizedReaction">0.00</span><br>
        graves: <span id="bassAmplitude">0</span><br>
        medios: <span id="midAmplitude">0</span><br>
        agudos: <span id="trebleAmplitude">0</span>
    </div>

    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button id="messageBoxOk">ok</button>
    </div>

    <script type="module">
        // --------------------------------------------------------------------------------------------------
        // ESTE ES TODO EL CÓDIGO JAVASCRIPT CORREGIDO Y COMPLETO PARA TU PROYECTO.
        // CÓPIALO TODO Y REEMPLAZA EL CONTENIDO DE TU ETIQUETA <script> EN TU ARCHIVO HTML.
        // --------------------------------------------------------------------------------------------------

        // Global variables for Firebase (will be initialized if persistence is needed)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Three.js variables for main visualizer
        let scene, camera, renderer;
        let audioContext, analyser, microphone, dataArray;
        let currentVisualMode = 'spheres';
        let visualObjects = []; // To manage objects for each visual mode
        let particleBurstSystem = null; // Particle system for the "burst"

        // Background layers (camera related variables removed)
        let imagePlane = null;
        let videoFeed = null; // Reference to the video element for camera feed
        let videoTexture = null; // Three.js texture for the video feed
        let isCameraActive = false; // Flag to indicate if camera is active
        let currentCameraStream = null; // Global reference to the camera media stream

        // Variables for image carousel
        let loadedImageTextures = [];
        let currentImageIndex = -1;
        let imageChangeInterval = null;
        const IMAGE_CHANGE_INTERVAL_MS = 2500; // 2.5 seconds

        // MIDI variables
        let midiAccess = null;
        let midiInputs = new Map();
        let midiOutputs = new Map();
        let selectedMidiInput = null;
        let selectedMidiChannel = 1; // Default MIDI channel
        let isLearningMidi = false;
        let learnTargetElement = null; // The visualizer control element being mapped
        let midiMappings = []; // Array to store {midiType, midiChannel, midiNumber, targetElementId, targetProperty, minVal, maxVal, step}

        // Control parameters for main visualizer
        const params = {
            colorSpeed: 0.1,
            amplitudeSensitivity: 1.0,
            audioReactionThreshold: 45, // Audio threshold for reaction (0-255)
            bassSensitivity: 1.0, // New sensitivity for bass
            midSensitivity: 1.0,  // New sensitivity for mids
            trebleSensitivity: 1.0, // New sensitivity for trebles
            layerOpacity: 1.0,
            shapeScale: 1.0,
            deformationLevel: 0.5,
            materialMode: 0, // 0: Solid, 1: Wireframe, 2: Points
            grayscale: false, // For figures
            customColors: ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'],

            // Background parameters (general for image/camera)
            chromaKeyColor: '#00FF00', // Chroma key color (green by default), only for images
            chromaKeyThreshold: 0.001,   // Chroma key tolerance threshold (very low initial value), only for images
            backgroundScaleFactor: 1.5, // Background image/camera scale factor

            // NEW IMAGE EFFECTS
            hueRotate: 0.0, // 0-360 degrees
            saturation: 1.0, // 0.0 (grayscale) to 2.0 (super saturated), 1.0 is normal
            vignette: 0.0, // 0.0 (none) to 1.0 (full vignette)
            posterize: 255.0, // 2 to 255 (number of levels per color channel)
            sharpen: 0.0, // 0.0 (none) to 10.0 (very sharp)
            scanline: 0.0, // 0.0 (none) to 1.0 (full scanlines)

            // Camera specific parameters (applied to background shader when camera is active)
            cameraFilterMode: 0, // 0:none, 1:grayscale, 2:invert, 3:sepia, 4:pixelate, 5:blur, 6:edge-only
            cameraNoiseAmount: 0.0, // 0.0 - 1.0
            cameraEdgeSensitivity: 0.5, // 0.0 - 1.0 (mapped from 0-100 slider)
            cameraBrightness: 0.0, // -1.0 - 1.0 (mapped from -100-100 slider)
            cameraContrast: 1.0, // 0.0 - 2.0 (mapped from 0-100 slider, 1.0 is neutral)
            cameraPixelateSize: 1.0, // 1.0 - 50.0 (mapped from 1-50 slider)
            cameraBlurAmount: 0.0, // 0.0 - 10.0 (mapped from 0-10 slider)
            cameraMaterialColor: new THREE.Color(0xFFFFFF), // White by default for edge tinting
        };

        // Material colors for background edges
        const backgroundMaterialColors = {
            none: new THREE.Color(0xFFFFFF),
            mercury: new THREE.Color(0xA0B0C0),
            gold: new THREE.Color(0xFFD700),
            lava: new THREE.Color(0xFF4500),
            water: new THREE.Color(0x00BFFF)
        };

        // DOM element references for main visualizer
        const appContainer = document.getElementById('app-container');
        const mainVisualizerPage = document.getElementById('mainVisualizerPage');
        const headerContainerMain = document.getElementById('headerContainerMain');
        const leftSidebarContainer = document.getElementById('leftSidebarContainer');
        const rightSidebarContainer = document.getElementById('rightSidebarContainer'); // Reference to the new right sidebar
        const footerContainer = document.getElementById('footerContainer');
        const visualCanvas = document.getElementById('visualCanvas');
        const visualModeSelect = document.getElementById('visualMode');
        const colorSpeedSlider = document.getElementById('colorSpeed');
        const amplitudeSensitivitySlider = document.getElementById('amplitudeSensitivity');
        const audioReactionThresholdSlider = document.getElementById('audioReactionThreshold');
        const bassSensitivitySlider = document.getElementById('bassSensitivity'); // New
        const midSensitivitySlider = document.getElementById('midSensitivity');   // New
        const trebleSensitivitySlider = document.getElementById('trebleSensitivity'); // New
        const layerOpacitySlider = document.getElementById('layerOpacity');
        const shapeScaleSlider = document.getElementById('shapeScale');
        const deformationLevelSlider = document.getElementById('deformationLevel');
        const materialModeSlider = document.getElementById('materialMode');
        const grayscaleToggle = document.getElementById('grayscaleToggle');
        const colorInputs = Array.from({ length: 6 }, (_, i) => document.getElementById(`color${i + 1}`));
        const toggleAudioBtn = document.getElementById('toggleAudio');
        const imageUploadInput = document.getElementById('imageUpload');
        const clearImageBtn = document.getElementById('clearImageBtn'); // New button
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxOkBtn = document.getElementById('messageBoxOk');
        const audioDebugInfo = document.getElementById('audioDebugInfo');
        const currentAmplitudeSpan = document.getElementById('currentAmplitude');
        const normalizedReactionSpan = document.getElementById('normalizedReaction');
        const bassAmplitudeSpan = document.getElementById('bassAmplitude');   // New
        const midAmplitudeSpan = document.getElementById('midAmplitude');     // New
        const trebleAmplitudeSpan = document.getElementById('trebleAmplitude'); // New

        // Background filter controls (general for image/camera)
        const chromaKeyColorInput = document.getElementById('chromaKeyColor');
        const chromaKeyThresholdSlider = document.getElementById('chromaKeyThreshold');
        const backgroundScaleSlider = document.getElementById('backgroundScaleSlider');

        // NEW IMAGE EFFECT SLIDERS DOM ELEMENTS
        const hueRotateSlider = document.getElementById('hueRotateSlider');
        const saturationSlider = document.getElementById('saturationSlider');
        const vignetteSlider = document.getElementById('vignetteSlider');
        const posterizeSlider = document.getElementById('posterizeSlider');
        const sharpenSlider = document.getElementById('sharpenSlider');
        const scanlineSlider = document.getElementById('scanlineSlider');

        // Camera specific controls (now in right sidebar)
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const cameraFilterModeSelect = document.getElementById('cameraFilterModeSelect');
        const cameraNoiseSlider = document.getElementById('cameraNoiseSlider');
        const cameraEdgeSensitivitySlider = document.getElementById('cameraEdgeSensitivitySlider');
        const cameraBrightnessSlider = document.getElementById('cameraBrightnessSlider');
        const cameraContrastSlider = document.getElementById('cameraContrastSlider');
        const cameraPixelateSizeSlider = document.getElementById('cameraPixelateSizeSlider');
        const cameraBlurAmountSlider = document.getElementById('cameraBlurAmountSlider');
        const cameraMaterialSelect = document.getElementById('cameraMaterialSelect');

        // Profile buttons
        const maroProfileBtn = document.getElementById('maroProfileBtn');
        const jucaProfileBtn = document.getElementById('jucaProfileBtn');
        const maroPage = document.getElementById('maroPage');
        const jucaPage = document.getElementById('jucaPage');
        const backButtons = document.querySelectorAll('.back-btn'); // Select all back buttons

        // MIDI section elements
        const midiInputSelect = document.getElementById('midiInputSelect');
        const midiOutputSelect = document.getElementById('midiOutputSelect');
        const midiChannelInput = document.getElementById('midiChannelInput');
        const startMidiLearnBtn = document.getElementById('startMidiLearnBtn');
        const stopMidiLearnBtn = document.getElementById('stopMidiLearnBtn');
        const midiLearnStatus = document.getElementById('midiLearnStatus');
        const midiMappingsTableBody = document.getElementById('midiMappingsTableBody');
        const midiMonitor = document.getElementById('midiMonitor');
        const clearMidiMappingsBtn = document.getElementById('clearMidiMappingsBtn');

        // Input device selection elements
        const audioInputSelect = document.getElementById('audioInputSelect');
        const cameraSelect = document.getElementById('cameraSelect'); // Now in left sidebar

        // All mappable controls (add data-midi-target="id" in HTML)
        const mappableControls = document.querySelectorAll('.mappable-control');
        
        // New Mobile UI Elements
        const sidebarToggleLeft = document.getElementById('sidebarToggleLeft');
        const sidebarToggleRight = document.getElementById('sidebarToggleRight');


        // --- Firebase Init ---
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized and user authenticated:", userId);
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage("¡Ojo! Hubo un error al iniciar Firebase. Algunas funciones podrían no jalar bien.");
            }
        };

        // Function to show custom messages
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.style.display = 'flex';
        }

        // Function to navigate between pages (only for Maro/JuCa)
        function navigateToPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                    // Manage main visualizer and camera states
                    if (pageId === 'mainVisualizerPage') {
                        // Show main visualizer UI
                        headerContainerMain.classList.remove('hidden');
                        if (window.innerWidth > 768) {
                            leftSidebarContainer.classList.remove('hidden');
                            rightSidebarContainer.classList.remove('hidden');
                        }
                        footerContainer.classList.remove('hidden');
                        if (audioContext && audioContext.state === 'running') {
                            audioDebugInfo.style.display = 'block';
                        }
                        // Ensure main visualizer animation is running
                        if (renderer.setAnimationLoop) {
                            renderer.setAnimationLoop(animateMainVisualizer);
                        }
                    } else { // Profile pages (Maro/JuCa)
                        // For profile pages, ensure their specific header and content are visible
                        const currentProfileHeader = page.querySelector('.header-container');
                        const currentProfileContent = page.querySelector('.profile-page-content');
                        if (currentProfileHeader) currentProfileHeader.classList.remove('hidden');
                        if (currentProfileContent) currentProfileContent.style.display = 'flex'; // Ensure content is displayed

                        headerContainerMain.classList.add('hidden'); // Hide main header
                        leftSidebarContainer.classList.add('hidden');
                        rightSidebarContainer.classList.add('hidden');
                        footerContainer.classList.add('hidden');
                        audioDebugInfo.style.display = 'none';
                        // Keep audio running, but stop camera if active
                        stopCameraAsBackground();
                        if (renderer.setAnimationLoop) {
                            renderer.setAnimationLoop(null); // Stop main visualizer loop
                        }
                    }
                } else {
                    page.classList.add('hidden');
                }
            });
            onWindowResize(); // Ensure canvas readjusts if necessary
        }

        // --- Main Visualizer Three.js Init and Resize ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: visualCanvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Clear to transparent black
            renderer.setPixelRatio(window.devicePixelRatio);

            camera.position.z = 5;

            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            const planeGeometry = new THREE.PlaneGeometry(2, 2); // A plane that covers the whole screen

            // Image/Camera Plane (unified background)
            imagePlane = new THREE.Mesh(planeGeometry, new THREE.ShaderMaterial({
                uniforms: {
                    backgroundTexture: { value: null },
                    isCameraActive: { value: false },
                    chromaKeyColor: { value: new THREE.Color(params.chromaKeyColor) },
                    chromaKeyThreshold: { value: params.chromaKeyThreshold },
                    backgroundFilterMode: { value: params.cameraFilterMode }, // Now uses cameraFilterMode
                    backgroundNoiseAmount: { value: params.cameraNoiseAmount },
                    backgroundEdgeSensitivity: { value: params.cameraEdgeSensitivity },
                    backgroundBrightness: { value: params.cameraBrightness },
                    backgroundContrast: { value: params.cameraContrast },
                    backgroundPixelateSize: { value: params.cameraPixelateSize },
                    backgroundBlurAmount: { value: params.cameraBlurAmount },
                    backgroundMaterialColor: { value: params.cameraMaterialColor },
                    audioVolume: { value: 0.0 }, // This will be updated from main analyser
                    time: { value: 0.0 },
                    // NEW IMAGE EFFECT UNIFORMS
                    uHueRotate: { value: params.hueRotate * Math.PI / 180.0 }, // Convert degrees to radians
                    uSaturation: { value: params.saturation / 100.0 }, // Normalize to 0-2
                    uVignette: { value: params.vignette / 100.0 }, // Normalize to 0-1
                    uPosterizeLevels: { value: params.posterize }, // Raw value 2-255
                    uSharpenAmount: { value: params.sharpen }, // Raw value 0-10
                    uScanlineDensity: { value: params.scanline / 100.0 }, // Normalize to 0-1
                },
                vertexShader: `
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D backgroundTexture;
                    uniform bool isCameraActive;
                    uniform vec3 chromaKeyColor;
                    uniform float chromaKeyThreshold;
                    uniform int backgroundFilterMode; // 0:none, 1:grayscale, 2:invert, 3:sepia, 4:pixelate, 5:blur, 6:edge-only
                    uniform float backgroundNoiseAmount;
                    uniform float backgroundEdgeSensitivity;
                    uniform float backgroundBrightness; // -1 to 1
                    uniform float backgroundContrast; // 0 to 2
                    uniform float backgroundPixelateSize;
                    uniform float backgroundBlurAmount;
                    uniform vec3 backgroundMaterialColor;
                    uniform float audioVolume;
                    uniform float time;

                    // NEW IMAGE EFFECT UNIFORMS
                    uniform float uHueRotate;
                    uniform float uSaturation;
                    uniform float uVignette;
                    uniform float uPosterizeLevels;
                    uniform float uSharpenAmount;
                    uniform float uScanlineDensity;

                    varying vec2 vUv;

                    // Simple hash function for random numbers in GLSL
                    float hash(vec2 p) {
                        return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);
                    }

                    // Perlin Noise (simplified)
                    float noise(vec2 st) {
                        vec2 i = floor(st);
                        vec2 f = fract(st);
                        vec2 u = f * f * (3.0 - 2.0 * f);
                        float a = hash(i);
                        float b = hash(i + vec2(1.0, 0.0));
                        float c = hash(i + vec2(0.0, 1.0));
                        float d = hash(i + vec2(1.0, 1.0));
                        return mix(mix(a, b, u.x), mix(c, d, u.x), u.y);
                    }

                    // Grayscale conversion
                    float toGrayscale(vec3 color) {
                        return dot(color, vec3(0.299, 0.587, 0.114));
                    }

                    // Apply brightness and contrast
                    vec3 applyBrightnessContrast(vec3 color, float bright, float cont) {
                        color += bright; // Apply brightness
                        color = (color - 0.5) * cont + 0.5; // Apply contrast
                        return clamp(color, 0.0, 1.0);
                    }

                    // Apply sepia filter
                    vec3 applySepia(vec3 color) {
                        float r = color.r;
                        float g = color.g;
                        float b = color.b;
                        vec3 sepiaColor;
                        sepiaColor.r = min(1.0, (r * 0.393) + (g * 0.769) + (b * 0.189));
                        sepiaColor.g = min(1.0, (r * 0.349) + (g * 0.686) + (b * 0.168));
                        sepiaColor.b = min(1.0, (r * 0.272) + (g * 0.534) + (b * 0.131));
                        return sepiaColor;
                    }

                    // Hue Rotation
                    vec3 rgbToHsv(vec3 c) {
                        vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
                        vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
                        vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
                        float d = q.x - min(q.w, q.y);
                        float e = 1.0e-10;
                        return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
                    }

                    vec3 hsvToRgb(vec3 c) {
                        vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                        vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                        return c.z * mix(K.xxx, clamp(p - K.x, 0.0, 1.0), c.y);
                    }

                    // Saturation
                    vec3 adjustSaturation(vec3 color, float sat) {
                        vec3 gray = vec3(dot(color, vec3(0.299, 0.587, 0.114)));
                        return mix(gray, color, sat);
                    }

                    // Vignette
                    vec3 applyVignette(vec3 color, float vignetteAmount) {
                        vec2 uv_centered = vUv - 0.5;
                        float dist = length(uv_centered);
                        float vignette = smoothstep(0.4, 0.8, dist); // Adjust these values for vignette size/falloff
                        return mix(color, color * (1.0 - vignetteAmount), vignette);
                    }

                    // Posterize
                    vec3 applyPosterize(vec3 color, float levels) {
                        return floor(color * levels) / levels;
                    }

                    // Sharpen (simple 3x3 convolution)
                    vec3 applySharpen(sampler2D tex, vec2 uv, float amount) {
                        vec2 texelSize = 1.0 / vec2(textureSize(tex, 0));
                        vec3 sum = vec3(0.0);

                        sum += texture2D(tex, uv + texelSize * vec2(-1, -1)).rgb * -0.07;
                        sum += texture2D(tex, uv + texelSize * vec2( 0, -1)).rgb * -0.07;
                        sum += texture2D(tex, uv + texelSize * vec2( 1, -1)).rgb * -0.07;
                        sum += texture2D(tex, uv + texelSize * vec2(-1,  0)).rgb * -0.07;
                        sum += texture2D(tex, uv).rgb * (1.0 + 8.0 * 0.07); // Center pixel weight
                        sum += texture2D(tex, uv + texelSize * vec2( 1,  0)).rgb * -0.07;
                        sum += texture2D(tex, uv + texelSize * vec2(-1,  1)).rgb * -0.07;
                        sum += texture2D(tex, uv + texelSize * vec2( 0,  1)).rgb * -0.07;
                        sum += texture2D(tex, uv + texelSize * vec2( 1,  1)).rgb * -0.07;

                        return mix(texture2D(tex, uv).rgb, sum, amount);
                    }

                    // Scanline
                    vec3 applyScanline(vec3 color, float density) {
                        float scanline = sin(vUv.y * 500.0) * 0.05 * density; // 500 lines, 0.05 intensity
                        return color * (1.0 - scanline);
                    }


                    void main() {
                        vec4 texColor = texture2D(backgroundTexture, vUv);
                        vec3 finalColor = texColor.rgb;

                        // 1. Apply Chroma Key (only for images, not camera)
                        // If camera is active, chroma key is bypassed (assuming camera doesn't need it)
                        if (!isCameraActive) {
                            vec3 diff = finalColor - chromaKeyColor;
                            float dist = length(diff);
                            if (dist < chromaKeyThreshold) {
                                discard; // Make pixel transparent
                            }
                        }

                        // 2. Apply Brightness and Contrast (always apply)
                        finalColor = applyBrightnessContrast(finalColor, backgroundBrightness, backgroundContrast);

                        // 3. Apply Base Filter Mode OR Edge-Only Mode (Camera filters take precedence if camera is active)
                        if (isCameraActive && backgroundFilterMode == 6) { // 'edge-only' mode for camera
                            // Convert to grayscale for edge detection
                            float currentGray = toGrayscale(finalColor);
                            vec2 texelSize = 1.0 / vec2(textureSize(backgroundTexture, 0));
                            float gX = 0.0;
                            float gY = 0.0;

                            // Sobel operator kernels (simplified for 2D)
                            gX += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(-1, -1)).rgb) * -1.0;
                            gX += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(-1, 0)).rgb) * -2.0;
                            gX += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(-1, 1)).rgb) * -1.0;
                            gX += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(1, -1)).rgb) * 1.0;
                            gX += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(1, 0)).rgb) * 2.0;
                            gX += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(1, 1)).rgb) * 1.0;

                            gY += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(-1, -1)).rgb) * -1.0;
                            gY += toGrayscale(texture2D(backgroundTexture, vUv + vec2(0, -1) * texelSize).rgb) * -2.0;
                            gY += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(1, -1)).rgb) * -1.0;
                            gY += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(-1, 1)).rgb) * 1.0;
                            gY += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(0, 1)).rgb) * 2.0;
                            gY += toGrayscale(texture2D(backgroundTexture, vUv + texelSize * vec2(1, 1)).rgb) * 1.0;

                            float edgeStrength = sqrt(gX * gX + gY * gY);
                            float dynamicEdgeThreshold = mix(0.3, 0.05, backgroundEdgeSensitivity);
                            dynamicEdgeThreshold = max(0.0, dynamicEdgeThreshold - audioVolume * 0.2); // Audio makes it more sensitive
                            
                            finalColor = vec3(0.0); // Start with black background for edges
                            if (edgeStrength > dynamicEdgeThreshold) {
                                finalColor = backgroundMaterialColor; // Apply material color to edges
                            }
                        } else if (isCameraActive) { // Apply other base filters for camera
                            if (backgroundFilterMode == 1) { // Grayscale
                                float gray = toGrayscale(finalColor);
                                finalColor = vec3(gray);
                            } else if (backgroundFilterMode == 2) { // Invert
                                finalColor = vec3(1.0 - finalColor.r, 1.0 - finalColor.g, 1.0 - finalColor.b);
                            } else if (backgroundFilterMode == 3) { // Sepia
                                finalColor = applySepia(finalColor);
                            } else if (backgroundFilterMode == 4) { // Pixelate
                                vec2 texelSize = 1.0 / vec2(textureSize(backgroundTexture, 0));
                                vec2 pixelatedUV = floor(vUv * backgroundPixelateSize) / backgroundPixelateSize;
                                finalColor = texture2D(backgroundTexture, pixelatedUV).rgb;
                            } else if (backgroundFilterMode == 5) { // Blur
                                vec2 texelSize = 1.0 / vec2(textureSize(backgroundTexture, 0));
                                vec3 blurredColor = vec3(0.0);
                                float count = 0.0;
                                for (float y = -backgroundBlurAmount; y <= backgroundBlurAmount; y += 1.0) {
                                    for (float x = -backgroundBlurAmount; x <= backgroundBlurAmount; x += 1.0) {
                                        blurredColor += texture2D(backgroundTexture, vUv + vec2(x, y) * texelSize).rgb;
                                        count += 1.0;
                                    }
                                }
                                finalColor = blurredColor / count;
                            }
                            // If backgroundFilterMode is 0 ('none'), no base filter is applied.
                        } else { // Apply NEW IMAGE EFFECTS only if camera is NOT active
                            if (uHueRotate != 0.0) {
                                vec3 hsv = rgbToHsv(finalColor);
                                hsv.x = fract(hsv.x + uHueRotate / (2.0 * 3.14159)); // Normalize angle to 0-1 range for HSV hue
                                finalColor = hsvToRgb(hsv);
                            }
                            if (uSaturation != 1.0) {
                                finalColor = adjustSaturation(finalColor, uSaturation);
                            }
                            if (uVignette > 0.0) {
                                finalColor = applyVignette(finalColor, uVignette);
                            }
                            if (uPosterizeLevels < 255.0) {
                                finalColor = applyPosterize(finalColor, uPosterizeLevels);
                            }
                            if (uSharpenAmount > 0.0) {
                                finalColor = applySharpen(backgroundTexture, vUv, uSharpenAmount);
                            }
                            if (uScanlineDensity > 0.0) {
                                finalColor = applyScanline(finalColor, uScanlineDensity);
                            }
                        }

                        // 4. Add Noise (always apply if noiseAmount > 0)
                        float n = noise(vUv * 100.0 + time * 0.5) * 2.0 - 1.0;
                        finalColor += n * backgroundNoiseAmount;

                        gl_FragColor = vec4(finalColor, 1.0);
                    }
                `,
                transparent: true,
                side: THREE.DoubleSide,
                blending: THREE.NormalBlending,
                depthWrite: false,
            }));
            imagePlane.position.z = -99; // Place it far back
            imagePlane.visible = false;
            scene.add(imagePlane);

            // Create the video element for camera feed (hidden)
            videoFeed = document.createElement('video');
            videoFeed.autoplay = true;
            videoFeed.playsInline = true;
            videoFeed.style.display = 'none'; // Keep it hidden
            // Append video element to body (it doesn't need to be in the canvas container)
            document.body.appendChild(videoFeed);

            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('fullscreenchange', onFullscreenChange);
        }
        
        // Función para cambiar el estado de las sidebars en móvil
        function toggleSidebar(sidebar) {
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('active');
            }
        }
        
        function onWindowResize() {
            // Adjust main visualizer canvas
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Adjust the size of background meshes (imagePlane)
            if (imagePlane && imagePlane.visible && imagePlane.material.uniforms.backgroundTexture && imagePlane.material.uniforms.backgroundTexture.value) {
                const texture = imagePlane.material.uniforms.backgroundTexture.value;
                // For video textures, the image property might not be immediately available
                const textureAspect = (texture.image && texture.image.videoWidth) ? texture.image.videoWidth / texture.image.videoHeight : (texture.image ? texture.image.width / texture.image.height : 1);

                const viewHeight = 2 * Math.tan(camera.fov * Math.PI / 360) * Math.abs(imagePlane.position.z - camera.position.z);
                const viewWidth = viewHeight * camera.aspect;

                let scaleX, scaleY;

                // Scale to cover the view, then apply backgroundScaleFactor
                if (viewWidth / textureAspect >= viewHeight) {
                    scaleX = viewWidth * params.backgroundScaleFactor;
                    scaleY = (viewWidth / textureAspect) * params.backgroundScaleFactor;
                } else {
                    scaleX = (viewHeight * textureAspect) * params.backgroundScaleFactor;
                    scaleY = viewHeight * params.backgroundScaleFactor;
                }
                imagePlane.scale.set(scaleX, scaleY, 1);
            }

            // Adjust the size of the fractal noise plane to cover the screen
            if (currentVisualMode === 'fractalNoise' && visualObjects.length > 0 && visualObjects[0].mesh) {
                const plane = visualObjects[0].mesh;
                const viewHeight = 2 * Math.tan(camera.fov * Math.PI / 360) * Math.abs(camera.position.z - plane.position.z);
                const viewWidth = viewHeight * camera.aspect;
                plane.scale.set(viewWidth, viewHeight, 1);
            }
            // Adjust the size of Hydra planes to cover the screen
            if ((currentVisualMode === 'hydraFuego' || currentVisualMode === 'hydraGlitch' || currentVisualMode === 'hydraTunel') && visualObjects.length > 0 && visualObjects[0].mesh) {
                const plane = visualObjects[0].mesh;
                const viewHeight = 2 * Math.tan(camera.fov * Math.PI / 360) * Math.abs(camera.position.z - plane.position.z);
                const viewWidth = viewHeight * camera.aspect;
                plane.scale.set(viewWidth, viewHeight, 1);
            }

            // Ajustar la visibilidad de los botones del menú y las sidebars en móvil
            const isMobile = window.innerWidth <= 768;
            sidebarToggleLeft.style.display = isMobile ? 'block' : 'none';
            sidebarToggleRight.style.display = isMobile ? 'block' : 'none';

            if (isMobile) {
                leftSidebarContainer.classList.add('hidden');
                leftSidebarContainer.classList.remove('active');
                rightSidebarContainer.classList.add('hidden');
                rightSidebarContainer.classList.remove('active');
            } else {
                leftSidebarContainer.classList.remove('hidden');
                rightSidebarContainer.classList.remove('hidden');
                leftSidebarContainer.classList.remove('active');
                rightSidebarContainer.classList.remove('active');
            }
        }

        function onFullscreenChange() {
            // Get all relevant UI containers
            const allHeaders = document.querySelectorAll('.header-container');
            const allSidebars = [leftSidebarContainer, rightSidebarContainer]; // Include both sidebars
            const allFooters = [footerContainer]; // Only one footer
            const allProfileContents = document.querySelectorAll('.profile-page-content'); // Contents of profile pages

            if (document.fullscreenElement) {
                // If entering fullscreen, hide all UI elements
                allHeaders.forEach(el => el.classList.add('hidden'));
                allSidebars.forEach(el => el.classList.add('hidden')); // Hide sidebars
                allFooters.forEach(el => el.classList.add('hidden'));
                allProfileContents.forEach(el => el.style.display = 'none'); // Hide content of profile pages
                audioDebugInfo.style.display = 'none';
                showMessage('¡pantalla completa activada! presiona esc para salir.'); // Message to exit
            } else {
                // If exiting fullscreen, show UI elements based on the active page
                const currentPage = document.querySelector('.page:not(.hidden)');

                if (currentPage && currentPage.id === 'mainVisualizerPage') {
                    headerContainerMain.classList.remove('hidden');
                    leftSidebarContainer.classList.remove('hidden'); // Show left sidebar
                    rightSidebarContainer.classList.remove('hidden'); // Show right sidebar
                    footerContainer.classList.remove('hidden');
                    if (audioContext && audioContext.state === 'running') {
                        audioDebugInfo.style.display = 'block';
                    }
                } else if (currentPage && (currentPage.id === 'maroPage' || currentPage.id === 'jucaPage')) {
                    // For profile pages, show their specific header and content
                    const currentProfileHeader = currentPage.querySelector('.header-container');
                    const currentProfileContent = currentPage.querySelector('.profile-page-content');
                    if (currentProfileHeader) currentProfileHeader.classList.remove('hidden');
                    if (currentProfileContent) currentProfileContent.style.display = 'flex'; // Assuming display flex for content
                }
            }
            onWindowResize(); // Readjust canvas and camera size
        }

        // --- Functions for different visual modes ---
        function clearVisuals() {
            visualObjects.forEach(obj => {
                if (obj.mesh) {
                    if (obj.mesh.geometry) obj.mesh.geometry.dispose();
                    if (obj.mesh.material) {
                        if (Array.isArray(obj.mesh.material)) {
                            obj.mesh.material.forEach(m => m.dispose());
                        } else {
                            obj.mesh.material.dispose();
                        }
                    }
                    scene.remove(obj.mesh);
                }
                if (obj.wireframe) {
                    if (obj.wireframe.geometry) obj.wireframe.geometry.dispose();
                    if (obj.wireframe.material) {
                        if (Array.isArray(obj.wireframe.material)) {
                            obj.wireframe.material.forEach(m => m.dispose());
                        } else {
                            obj.wireframe.material.dispose();
                        }
                    }
                    scene.remove(obj.wireframe);
                }
                if (obj.points) {
                    if (obj.points.geometry) obj.points.geometry.dispose();
                    if (obj.points.material) {
